---
title: "[Spring] @Async ì‚¬ìš© ë°©ë²•ê³¼ ì£¼ì˜ì‚¬í•­"
excerpt_separator: "<!--more-->"
categories:
- development

tags:
- spring
- async
- annotation
---

ì˜¤ëŠ˜ì€ spring ì—ì„œ ì œê³µí•˜ëŠ” @Async ì–´ë…¸í…Œì´ì…˜ì„ í†µí•œ ë¹„ë™ê¸° ì²˜ë¦¬ì— ëŒ€í•´ ê°„ëµíˆ ì •ë¦¬í•´ ë³´ë ¤ê³  í•©ë‹ˆë‹¤.
<!--more-->

### @Async
> ì–´ë…¸í…Œì´ì…˜ì„ í†µí•´ ê°„ë‹¨í•˜ê²Œ ë¹„ë™ê¸° ë©”ì„œë“œë¥¼ ì‹¤í–‰

@Async ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš©ì„ ìœ„í•´ì„  @EnableAsync ì–´ë…¸í…Œì´ì…˜ì„ ë¨¼ì € ë¶™í˜€ì¤˜ì•¼ í•œë‹¤.
```java
@EnableAsync
@SpringBootApplication
public class DemoApplication {
	public static void main(String[] args) {
		SpringApplication.run(DemoApplication.class, args);
	}
}
```
```java
@Slf4j
@Service
public class CallService {
	private final AsyncService asyncService;

	public CallService(AsyncService asyncService) {
		this.asyncService = asyncService;
	}

	public void callAsync() {
		log.info(">>>>> callAsync!!");
		asyncService.async1();
		asyncService.async2();
	}
}
```
```java
@Slf4j
@Service
public class AsyncService {
	@Async
	public void async1() {
		log.info(">>>>> async1()");
		for (int i = 0; i < 5; i++) {
			log.info(">>>>> Thread Name : " + Thread.currentThread().getName());
		}
	}

	@Async
	public void async2() {
		log.info(">>>>> async2()");
		for (int i = 0; i < 5; i++) {
			log.info(">>>>> Thread Name : " + Thread.currentThread().getName());
		}
	}
}
```
```shell
2024-10-26T15:28:19.029+09:00  INFO 3614 --- [demo] [    Test worker] com.example.demo.async.CallService       : >>>>> callAsync!!
2024-10-26T15:28:19.034+09:00  INFO 3614 --- [demo] [ taskExecutor-1] com.example.demo.async.AsyncService      : >>>>> async1()
2024-10-26T15:28:19.034+09:00  INFO 3614 --- [demo] [ taskExecutor-2] com.example.demo.async.AsyncService      : >>>>> async2()
2024-10-26T15:28:19.034+09:00  INFO 3614 --- [demo] [ taskExecutor-1] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-1
2024-10-26T15:28:19.034+09:00  INFO 3614 --- [demo] [ taskExecutor-1] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-1
2024-10-26T15:28:19.034+09:00  INFO 3614 --- [demo] [ taskExecutor-2] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-2
2024-10-26T15:28:19.034+09:00  INFO 3614 --- [demo] [ taskExecutor-1] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-1
2024-10-26T15:28:19.035+09:00  INFO 3614 --- [demo] [ taskExecutor-2] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-2
2024-10-26T15:28:19.035+09:00  INFO 3614 --- [demo] [ taskExecutor-2] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-2
2024-10-26T15:28:19.035+09:00  INFO 3614 --- [demo] [ taskExecutor-2] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-2
2024-10-26T15:28:19.035+09:00  INFO 3614 --- [demo] [ taskExecutor-2] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-2
2024-10-26T15:28:19.035+09:00  INFO 3614 --- [demo] [ taskExecutor-1] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-1
2024-10-26T15:28:19.035+09:00  INFO 3614 --- [demo] [ taskExecutor-1] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-1
```
> ìœ„ ì½”ë“œë¥¼ ì‹¤í–‰í•´ ë³´ë©´ ìœ„ì™€ ê°™ì´ `ê° taskExecutor-1 ì™€ taskExecutor-2 ìŠ¤ë ˆë“œì—ì„œ ë¹„ë™ê¸° ì ìœ¼ë¡œ async1, async2 ë©”ì†Œë“œê°€ ì‹¤í–‰ë˜ëŠ” ê±¸ í™•ì¸`í•  ìˆ˜ ìˆë‹¤.

@Async ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì•„ë˜ì™€ ê°™ì€ ê²°ê³¼ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤.
```shell
2024-10-26T15:32:36.270+09:00  INFO 3755 --- [demo] [    Test worker] com.example.demo.async.CallService       : >>>>> callAsync!!
2024-10-26T15:32:36.270+09:00  INFO 3755 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> async1()
2024-10-26T15:32:36.270+09:00  INFO 3755 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker
2024-10-26T15:32:36.270+09:00  INFO 3755 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker
2024-10-26T15:32:36.270+09:00  INFO 3755 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker
2024-10-26T15:32:36.270+09:00  INFO 3755 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker
2024-10-26T15:32:36.270+09:00  INFO 3755 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker
2024-10-26T15:32:36.271+09:00  INFO 3755 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> async2()
2024-10-26T15:32:36.271+09:00  INFO 3755 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker
2024-10-26T15:32:36.271+09:00  INFO 3755 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker
2024-10-26T15:32:36.271+09:00  INFO 3755 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker
2024-10-26T15:32:36.271+09:00  INFO 3755 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker
2024-10-26T15:32:36.271+09:00  INFO 3755 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker

```
> `Test worker ë€ ìŠ¤ë ˆë“œì—ì„œ async1 ì´ ì‹¤í–‰ëœ ì´í›„ async2 ë©”ì†Œë“œê°€ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ”ê±¸ í™•ì¸`í•  ìˆ˜ ìˆë‹¤.

- ThreadExecutor ë¡œ default ë¡œ SimpleAsyncTaskExecutor ë¥¼ ì‚¬ìš©
  - ê° ì‘ì—…ë§ˆë‹¤ ìƒˆë¡œìš´ ìŠ¤ë ˆë“œë¥¼ ìƒì„±í•˜ê³  ë¹„ë™ê¸° ë°©ì‹ìœ¼ë¡œ ë™ì‘
  - concurrency limit í”„ë¡œí¼í‹°ë¥¼ ì´ìš©í•´ ì§€ì •í•œ ìˆ˜ ë³´ë‹¤ ìš”ì²­ì´ ë„˜ì–´ì„¤ ê²½ìš° ì œí•œì„ ê±¸ ìˆ˜ ìˆë‹¤.
- ì‘ë™ ë°©ì‹
  - spring AOP ì— ì˜í•´ Proxy ë°©ì‹ìœ¼ë¡œ ì‘ë™
  - Async Bean ì´ ë“±ë¡ë˜ëŠ” ì‹œì ì— Proxy ê°ì²´í™” í•˜ì—¬ ë“±ë¡
    - í˜¸ì¶œí•œ ê°ì²´ëŠ” Proxy ê°ì²´í™”ëœ Async Bean ì°¸ì¡°
> private method, inner-method í˜¸ì¶œ ì‹œ Async ë™ì‘ í•˜ì§€ ì•ŠëŠ”ë‹¤

- ì£¼ì˜ì 
  - Exception Handling
    - @Async ë©”ì„œë“œì— ë°œìƒí•˜ëŠ” ì˜ˆì™¸ëŠ” í˜¸ì¶œìì—ê²Œ ì „íŒŒë˜ì§€ ì•ŠëŠ”ë‹¤. (ë³„ë„ì˜ thread ì‹¤í–‰)
    - AsyncUncaughtExceptionHandler ë¥¼ êµ¬í˜„í•˜ì—¬ ì˜ˆì™¸ì²˜ë¦¬ ë˜ëŠ” CompletableFuture ì˜ exceptionally() ë©”ì†Œë“œ ë¥¼ í™œìš©í•œ ì˜ˆì™¸ì²˜ë¦¬ê°€ í•„ìš”
  - Method í˜¸ì¶œ
    - ë‚´ë¶€ í˜¸ì¶œ ì‹œ async ë™ì‘ í•˜ì§€ ì•ŠëŠ”ë‹¤.
    
```java
    public void callInnerAsync() {
		log.info("[ë‚´ë¶€ í´ë˜ìŠ¤ì˜ Async ë©”ì†Œë“œ í˜¸ì¶œ]");
		this.async1();
		this.async2();
	}
```
```shell
2024-10-26T15:40:12.606+09:00  INFO 3933 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : [ë‚´ë¶€ í´ë˜ìŠ¤ì˜ Async ë©”ì†Œë“œ í˜¸ì¶œ]
2024-10-26T15:40:12.606+09:00  INFO 3933 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> async1()
2024-10-26T15:40:12.606+09:00  INFO 3933 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker
2024-10-26T15:40:12.606+09:00  INFO 3933 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker
2024-10-26T15:40:12.606+09:00  INFO 3933 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker
2024-10-26T15:40:12.606+09:00  INFO 3933 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker
2024-10-26T15:40:12.606+09:00  INFO 3933 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker
2024-10-26T15:40:12.606+09:00  INFO 3933 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> async2()
2024-10-26T15:40:12.606+09:00  INFO 3933 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker
2024-10-26T15:40:12.606+09:00  INFO 3933 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker
2024-10-26T15:40:12.607+09:00  INFO 3933 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker
2024-10-26T15:40:12.607+09:00  INFO 3933 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker
2024-10-26T15:40:12.607+09:00  INFO 3933 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> Thread Name : Test worker

```

  - ë¦¬í„´ íƒ€ì…
    - void, Future, CompletableFuture ì¤‘ í•˜ë‚˜ì˜ ë°˜í™˜ íƒ€ì…ì„ ê°€ì ¸ì•¼ í•œë‹¤.
    - Future, CompletableFuture ëŠ” non-blocking ë°©ì‹ìœ¼ë¡œ ì ‘ê·¼, í•„ìš”ì‹œ callback ì‚¬ìš© ì²˜ë¦¬

```java
	@Async
	public String async3() {
		log.info(">>>>> async3()");
		for (int i = 0; i < 5; i++) {
			log.info(">>>>> Thread Name : " + Thread.currentThread().getName());
		}
		return "Hello, world";
	}
```
```java
	public void callAsyncReturnString() {
		log.info(">>>>> callAsyncReturnString");
		System.out.println(asyncService.async3());
	}
```
```shell
2024-10-26T15:44:28.456+09:00  INFO 4162 --- [demo] [    Test worker] com.example.demo.async.CallService       : >>>>> callAsyncReturnString

Invalid return type for async method (only Future and void supported): class java.lang.String
java.lang.IllegalArgumentException: Invalid return type for async method (only Future and void supported): class java.lang.String
	at org.springframework.aop.interceptor.AsyncExecutionAspectSupport.doSubmit(AsyncExecutionAspectSupport.java:301)
```
> ìœ„ì™€ ê°™ì´ String íƒ€ì…ì„ ë¦¬í„´í•˜ê²Œ í•˜ë©´ ìœ„ì˜ ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ” ê±¸ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


```java
	@Async
	public CompletableFuture<String> asyncReturnCompletableFuture() {
		log.info(">>>>> asyncReturnCompletableFuture()");
		for (int i = 0; i < 5; i++) {
			log.info(">>>>> Thread Name : " + Thread.currentThread().getName() + ", " + i);
		}
		return CompletableFuture.completedFuture("Hello, world!!");
	}
```
```java
	public void callAsyncReturnCompleteFuture() {
		CompletableFuture<String> completableFuture = asyncService.asyncReturnCompletableFuture();
		completableFuture.thenApply(result -> {
			log.info(">>>>> Thread Name : " + Thread.currentThread().getName() + " result : " + result  + ", " + LocalDateTime.now());
			return result;
		}).exceptionally(e -> {
			log.error("ì˜ˆì™¸ ë°œìƒ" + e.getMessage());
			return "";
		});
	}
```
```shell
2024-10-26T15:48:41.420+09:00  INFO 4264 --- [demo] [ taskExecutor-1] com.example.demo.async.AsyncService      : >>>>> asyncReturnCompletableFuture()
2024-10-26T15:48:41.420+09:00  INFO 4264 --- [demo] [ taskExecutor-1] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-1, 0
2024-10-26T15:48:41.420+09:00  INFO 4264 --- [demo] [ taskExecutor-1] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-1, 1
2024-10-26T15:48:41.420+09:00  INFO 4264 --- [demo] [ taskExecutor-1] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-1, 2
2024-10-26T15:48:41.420+09:00  INFO 4264 --- [demo] [ taskExecutor-1] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-1, 3
2024-10-26T15:48:41.421+09:00  INFO 4264 --- [demo] [ taskExecutor-1] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-1, 4
2024-10-26T15:48:41.421+09:00  INFO 4264 --- [demo] [ taskExecutor-3] com.example.demo.async.AsyncService      : >>>>> asyncReturnCompletableFuture()
2024-10-26T15:48:41.421+09:00  INFO 4264 --- [demo] [ taskExecutor-2] com.example.demo.async.AsyncService      : >>>>> asyncReturnCompletableFuture()
2024-10-26T15:48:41.421+09:00  INFO 4264 --- [demo] [ taskExecutor-1] com.example.demo.async.CallService       : >>>>> Thread Name : taskExecutor-1 result : Hello, world!!, 2024-10-26T15:48:41.421313
2024-10-26T15:48:41.421+09:00  INFO 4264 --- [demo] [ taskExecutor-3] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-3, 0
2024-10-26T15:48:41.421+09:00  INFO 4264 --- [demo] [ taskExecutor-2] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-2, 0
2024-10-26T15:48:41.421+09:00  INFO 4264 --- [demo] [ taskExecutor-3] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-3, 1
2024-10-26T15:48:41.422+09:00  INFO 4264 --- [demo] [ taskExecutor-2] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-2, 1
2024-10-26T15:48:41.422+09:00  INFO 4264 --- [demo] [ taskExecutor-2] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-2, 2
2024-10-26T15:48:41.422+09:00  INFO 4264 --- [demo] [ taskExecutor-3] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-3, 2
2024-10-26T15:48:41.422+09:00  INFO 4264 --- [demo] [ taskExecutor-2] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-2, 3
2024-10-26T15:48:41.422+09:00  INFO 4264 --- [demo] [ taskExecutor-2] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-2, 4
2024-10-26T15:48:41.422+09:00  INFO 4264 --- [demo] [ taskExecutor-3] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-3, 3
2024-10-26T15:48:41.422+09:00  INFO 4264 --- [demo] [ taskExecutor-3] com.example.demo.async.AsyncService      : >>>>> Thread Name : taskExecutor-3, 4
2024-10-26T15:48:41.422+09:00  INFO 4264 --- [demo] [ taskExecutor-2] com.example.demo.async.CallService       : >>>>> Thread Name : taskExecutor-2 result : Hello, world!!, 2024-10-26T15:48:41.422571
2024-10-26T15:48:41.422+09:00  INFO 4264 --- [demo] [ taskExecutor-3] com.example.demo.async.CallService       : >>>>> Thread Name : taskExecutor-3 result : Hello, world!!, 2024-10-26T15:48:41.422776
```
> CompletableFuture ê³¼ thenApply ë©”ì†Œë“œë¥¼ ì´ìš©í•˜ë©´, non-blocking  ë°©ì‹ìœ¼ë¡œ ë¦¬í„´ê°’ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

  - íŠ¸ëœì­ì…˜ ê´€ë¦¬
    - ë¹„ë™ê¸° ë©”ì„œë“œ ë‚´ì—ì„œ íŠ¸ëœì­ì…˜ì€ í˜¸ì¶œí•œ ë©”ì„œë“œì˜ íŠ¸ëœì­ì…˜ê³¼ëŠ” ë³„ê°œì˜ ìƒëª…ì£¼ê¸°ë¥¼ ê°€ì§„ë‹¤.
    - @Async ë¶™ì€ ë©”ì„œë“œì—ì„œ rollback ì´ ë°œìƒí•´ë„ í˜¸ì¶œí•œ ë©”ì„œë“œëŠ” commit ëœë‹¤.
    
```java
	@Transactional
	public void transactionalMethod() {
		log.info(">>>>> tx.name : " + TransactionSynchronizationManager.getCurrentTransactionName());
		log.info(">>>>> tx.isActive : " + TransactionSynchronizationManager.isActualTransactionActive());
		asyncService.asyncWithTransactional();
		asyncService.noAsyncWithTransactional();
	}
```
```java
	@Async
	@Transactional
	public void asyncWithTransactional() {
		log.info(">>>>> asyncWithTransactional()");
		log.info(">>>>> asyncWithTransactional tx.name : " + TransactionSynchronizationManager.getCurrentTransactionName());
		log.info(">>>>> asyncWithTransactional tx.isActive : " + TransactionSynchronizationManager.isActualTransactionActive());
	}

	@Transactional
	public void noAsyncWithTransactional() {
		log.info(">>>>> noAsyncWithTransactional()");
		log.info(">>>>> noAsyncWithTransactional tx.name : " + TransactionSynchronizationManager.getCurrentTransactionName());
		log.info(">>>>> noAsyncWithTransactional tx.isActive : " + TransactionSynchronizationManager.isActualTransactionActive());
	}
```
```shell
2024-10-26T15:58:58.316+09:00  INFO 4515 --- [demo] [    Test worker] com.example.demo.async.CallService       : >>>>> tx.name : com.example.demo.async.CallService.transactionalMethod
2024-10-26T15:58:58.316+09:00  INFO 4515 --- [demo] [    Test worker] com.example.demo.async.CallService       : >>>>> tx.isActive : true
2024-10-26T15:58:58.318+09:00  INFO 4515 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> noAsyncWithTransactional()
2024-10-26T15:58:58.319+09:00  INFO 4515 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> noAsyncWithTransactional tx.name : com.example.demo.async.CallService.transactionalMethod
2024-10-26T15:58:58.319+09:00  INFO 4515 --- [demo] [ taskExecutor-1] com.example.demo.async.AsyncService      : >>>>> asyncWithTransactional()
2024-10-26T15:58:58.319+09:00  INFO 4515 --- [demo] [    Test worker] com.example.demo.async.AsyncService      : >>>>> noAsyncWithTransactional tx.isActive : true
2024-10-26T15:58:58.319+09:00  INFO 4515 --- [demo] [ taskExecutor-1] com.example.demo.async.AsyncService      : >>>>> asyncWithTransactional tx.name : com.example.demo.async.AsyncService.asyncWithTransactional
2024-10-26T15:58:58.319+09:00  INFO 4515 --- [demo] [ taskExecutor-1] com.example.demo.async.AsyncService      : >>>>> asyncWithTransactional tx.isActive : true
```
> ìœ„ì™€ ê°™ì´ @Async ê°€ ì—†ëŠ” ë©”ì„œë“œëŠ” `noAsyncWithTransactional tx.name : com.example.demo.async.CallService.transactionalMethod` ì™€ ê°™ì´ Default ì „íŒŒ ì˜µì…˜ì¸ REQUIRED ì— ë”°ë¼ í˜¸ì¶œìì˜ íŠ¸ëœì­ì…˜ì— ì°¸ì—¬í•˜ë‚˜, @Async ì™€ @Transactional ì´ ë¶™ì€ ë©”ì„œë“œëŠ” `asyncWithTransactional tx.name : com.example.demo.async.AsyncService.asyncWithTransactional` ì™€ ê°™ì´ ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ì„ ê°€ì§€ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.

```java
@Slf4j
@Service
public class ProductService {
	private final ProductRepository repository;

	public ProductService(ProductRepository repository) {
		this.repository = repository;
	}

	@Transactional
	public Product save(Product product) {
		log.info(">>>>> ProductService.save tx.name : " + TransactionSynchronizationManager.getCurrentTransactionName());
		return repository.saveAndFlush(product);
	}
}
```
```java
	@Transactional
	public void saveAndNoException() {
		log.info(">>>>> CallService.saveAndNoException tx.name : "
			+ TransactionSynchronizationManager.getCurrentTransactionName());
		productService.save(Product.builder()
			.name("ë“±ë¡ì„±ê³µ")
			.price(10000)
			.build());

		asyncService.saveAndException();
	}
```
```java
	@Async
	@Transactional
	public void saveAndException() {
		log.info(">>>>> AsyncService.saveAndException tx.name : " + TransactionSynchronizationManager.getCurrentTransactionName());
		productService.save(Product.builder()
				.name("ë¯¸ë“±ë¡")
				.price(10000)
			.build());
		throw new RuntimeException("ìµì…‰ì…˜!");
	}
```
```shell
2024-10-26T16:06:38.658+09:00  INFO 4635 --- [demo] [nio-8080-exec-1] com.example.demo.async.CallService       : >>>>> CallService.saveAndNoException tx.name : com.example.demo.async.CallService.saveAndNoException
2024-10-26T16:06:38.658+09:00  INFO 4635 --- [demo] [nio-8080-exec-1] com.example.demo.jpa.ProductService      : >>>>> ProductService.save tx.name : com.example.demo.async.CallService.saveAndNoException
Hibernate: insert into product (category,name,price,id) values (?,?,?,default)
2024-10-26T16:06:38.723+09:00  INFO 4635 --- [demo] [ taskExecutor-1] com.example.demo.async.AsyncService      : >>>>> AsyncService.saveAndException tx.name : com.example.demo.async.AsyncService.saveAndException
2024-10-26T16:06:38.723+09:00  INFO 4635 --- [demo] [ taskExecutor-1] com.example.demo.jpa.ProductService      : >>>>> ProductService.save tx.name : com.example.demo.async.AsyncService.saveAndException
Hibernate: insert into product (category,name,price,id) values (?,?,?,default)
2024-10-26T16:06:38.727+09:00 ERROR 4635 --- [demo] [ taskExecutor-1] .a.i.SimpleAsyncUncaughtExceptionHandler : Unexpected exception occurred invoking async method: public void com.example.demo.async.AsyncService.saveAndException()

java.lang.RuntimeException: ìµì…‰ì…˜!
```
![commit ì„±ê³µ](/images/posts/2024/10/3.png)
> ìœ„ì™€ ê°™ì´ `AsyncService.saveAndException tx.name : com.example.demo.async.AsyncService.saveAndException` ë³„ë„ íŠ¸ëœì­ì…˜ì„ ìƒì„±í•˜ì—¬, ìµì…‰ì…˜ ë°œìƒìœ¼ë¡œ rollback ì´ ë˜ì—ˆì§€ë§Œ, `com.example.demo.async.CallService.saveAndNoException` ì€ commit ì´ ë˜ì–´ DB ìƒì— ë°ì´í„°ê°€ ì •ìƒ ë“±ë¡ëœê±¸ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

  - Executor
    - ê¸°ë³¸ì ìœ¼ë¡œ simpleAsyncTaskExecutor ì‚¬ìš©, ì‘ì—…ë§ˆë‹¤ ìƒˆë¡œìš´ ìŠ¤ë ˆë“œ ìƒì„± (ìì› ë¹„íš¨ìœ¨)
    - ThreadPoolTaskExecutor ì‚¬ìš© ê¶Œì¥

```java
@EnableAsync
@Configuration
public class AsyncConfig {
	@Bean(name = "taskExecutor")
	public ThreadPoolTaskExecutor executor(){
		ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
		executor.setCorePoolSize(5);
		executor.setQueueCapacity(20);
		executor.setMaxPoolSize(10);
		executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
		return executor;
	}
}
```
```java
	@Async("taskExecutor")
```
> ThreadPoolTaskExecutor ì‚¬ìš©ì„ ìœ„í•´ì„œëŠ” ë³„ë„ì˜ Config í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ ìœ„ì™€ ê°™ì´ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.

### ë§ˆë¬´ë¦¬
@Async ì–´ë…¸í…Œì´ì…˜ê³¼ ê°„ëµí•˜ê²Œ ì£¼ë³€ ì§€ì‹ì— ëŒ€í•´ í•™ìŠµí•´ ë³¼ ìˆ˜ ìˆëŠ” ì‹œê°„ì´ì˜€ìŠµë‹ˆë‹¤. 

ì‹¤ë¬´ì—ì„œ ì•„ì§ ë¹„ë™ê¸° ì²˜ë¦¬ëŠ” ê²½í—˜í•˜ì§€ ëª» í•´ì„œ ë¹¨ë¦¬ ì‹¤ë¬´ì—ì„œ ë‹¤ì–‘í•œ ë¹„ë™ê¸° ì²˜ë¦¬ ë°©ì‹ì„ ì‚¬ìš©í•´ ë³´ê³  ì‹¶ì€ ë§ˆìŒì´ ë“œë„¤ìš”.

ì¶”í›„ ThreadPoolTaskExecutor ê³¼ Future, CompletableFuture ë“±ì— ëŒ€í•´ì„œë„ ê°„ëµíˆ í…ŒìŠ¤íŠ¸ ì½”ë“œì™€ í•¨ê»˜ í¬ìŠ¤íŒ… í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

ê·¸ëŸ¼ ì´ë§Œ. ğŸ¥•ğŸ‘‹ğŸ¼ğŸ–ğŸ¼

### ì°¸ê³ ìë£ŒğŸ¤£
[ìŠ¤í”„ë§ì—ì„œ @Asyncë¥¼ ì‚¬ìš©í• ë•Œ ì£¼ì˜ì ](https://dkswnkk.tistory.com/706)  
[[Spring] @Asyncë¡œ ë¹„ë™ê¸° ì²˜ë¦¬í•˜ê¸°](https://velog.io/@think2wice/Spring-Async-Thread-Pool%EC%97%90-%EB%8C%80%ED%95%98%EC%97%AC-Async)
